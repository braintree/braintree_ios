name: Tests
on: [pull_request]
concurrency:
  group: tests-${{ github.event.number }}
  cancel-in-progress: true
jobs:
  build_unit_tests:
    name: Build Unit Tests
    runs-on: macos-15-xlarge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install Package dependencies
        run: swift package resolve

      - name: Install CocoaPod dependencies
        run: pod install

      - name: Build UnitTests for Testing
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          xcodebuild build-for-testing \
            -workspace 'Braintree.xcworkspace' \
            -scheme 'UnitTests' \
            -sdk 'iphonesimulator' \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -derivedDataPath DerivedData \
            DEBUG_INFORMATION_FORMAT=dwarf | ./Pods/xcbeautify/xcbeautify

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unit-build-artifacts
          path: |
            DerivedData/Build/Products
            Braintree.xcworkspace
            Pods
          retention-days: 1

  build_ui_tests:
    name: Build UI Tests
    runs-on: macos-15-xlarge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install Package dependencies
        run: swift package resolve

      - name: Install CocoaPod dependencies
        run: pod install

      - name: Build UITests for Testing
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          xcodebuild build-for-testing \
            -workspace 'Braintree.xcworkspace' \
            -scheme 'UITests' \
            -sdk 'iphonesimulator' \
            -configuration 'Release' \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -derivedDataPath DerivedData \
            DEBUG_INFORMATION_FORMAT=dwarf | ./Pods/xcbeautify/xcbeautify

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ui-build-artifacts
          path: |
            DerivedData/Build/Products
            Braintree.xcworkspace
            Pods
          retention-days: 1

  build_integration_tests:
    name: Build Integration Tests
    runs-on: macos-15-xlarge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install Package dependencies
        run: swift package resolve

      - name: Install CocoaPod dependencies
        run: pod install

      - name: Build IntegrationTests for Testing
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          xcodebuild build-for-testing \
            -workspace 'Braintree.xcworkspace' \
            -scheme 'IntegrationTests' \
            -sdk 'iphonesimulator' \
            -configuration 'Release' \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -derivedDataPath DerivedData \
            DEBUG_INFORMATION_FORMAT=dwarf | ./Pods/xcbeautify/xcbeautify

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: integration-build-artifacts
          path: |
            DerivedData/Build/Products
            Braintree.xcworkspace
            Pods
          retention-days: 1

  unit_test_job:
    name: Unit
    needs: build_unit_tests
    runs-on: macos-15-xlarge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: unit-build-artifacts

      - name: Run Unit Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UnitTests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' | ./Pods/xcbeautify/xcbeautify
  threeds_ui_test_job:
    name: UI Tests - ThreeDSecure
    needs: build_ui_tests
    runs-on: macos-15-xlarge
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build-artifacts

      - name: Run ThreeDSecure UI Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UITests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -only-testing:UITests/ThreeDSecure_V2_UITests \
            -retry-tests-on-failure | ./Pods/xcbeautify/xcbeautify

  paypal_checkout_ui_test_job:
    name: UI Tests - PayPal Checkout
    needs: build_ui_tests
    runs-on: macos-15-xlarge
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build-artifacts

      - name: Setup Simulator for ASWebAuthenticationSession
        run: |
          # ASWebAuthenticationSession requires Simulator.app to be open and frontmost
          # to provide a valid presentation anchor (key window)
          # Note: xcodebuild will automatically boot the simulator, we just need the UI window

          open -a Simulator
          sleep 3
          osascript -e 'tell application "Simulator" to activate'
          sleep 1
          # Ensure simulator is fully ready
          xcrun simctl list devices | grep "iPhone 16 Pro"

      - name: Run PayPal Checkout UI Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UITests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=26.0,platform=iOS Simulator' \
            -only-testing:UITests/PayPal_Checkout_UITests \
            -retry-tests-on-failure | ./Pods/xcbeautify/xcbeautify

  paypal_vault_ui_test_job:
    name: UI Tests - PayPal Vault
    needs: build_ui_tests
    runs-on: macos-15-xlarge
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build-artifacts

      - name: Setup Simulator for ASWebAuthenticationSession
        run: |
          # ASWebAuthenticationSession requires Simulator.app to be open and frontmost
          # to provide a valid presentation anchor (key window)
          # Note: xcodebuild will automatically boot the simulator, we just need the UI window

          open -a Simulator
          sleep 3
          osascript -e 'tell application "Simulator" to activate'
          sleep 1
          # Ensure simulator is fully ready
          xcrun simctl list devices | grep "iPhone 16 Pro"

      - name: Run PayPal Vault UI Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UITests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=26.0,platform=iOS Simulator' \
            -only-testing:UITests/PayPal_Vault_UITests \
            -retry-tests-on-failure | ./Pods/xcbeautify/xcbeautify

  paypal_messaging_ui_test_job:
    name: UI Tests - PayPal Messaging
    needs: build_ui_tests
    runs-on: macos-15-xlarge
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build-artifacts

      - name: Run PayPal Messaging UI Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UITests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -only-testing:UITests/PayPalMessaging_Success_UITests \
            -only-testing:UITests/PayPalMessaging_Failure_UITests \
            -retry-tests-on-failure | ./Pods/xcbeautify/xcbeautify

  venmo_ui_test_job:
    name: UI Tests - Venmo
    needs: build_ui_tests
    runs-on: macos-15-xlarge
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-build-artifacts

      - name: Run Venmo UI Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*UITests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' \
            -only-testing:UITests/Venmo_UITests \
            -retry-tests-on-failure | ./Pods/xcbeautify/xcbeautify

  integration_test_job:
    name: Integration
    needs: build_integration_tests
    runs-on: macos-15-xlarge
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}

      - name: Use Xcode 16.4
        run: sudo xcode-select -switch /Applications/Xcode_16.4.0.app

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: integration-build-artifacts

      - name: Run Integration Tests
        run: |
          set -o pipefail
          chmod +x Pods/xcbeautify/xcbeautify
          XCTESTRUN=$(find DerivedData/Build/Products -name '*IntegrationTests*.xctestrun' | head -n 1)
          xcodebuild test-without-building \
            -xctestrun "$XCTESTRUN" \
            -destination 'name=iPhone 16 Pro,OS=18.5,platform=iOS Simulator' | ./Pods/xcbeautify/xcbeautify
